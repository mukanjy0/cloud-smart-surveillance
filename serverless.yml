org: mukanjy0
service: apiSmartSurveillance

provider:
  name: aws
  runtime: python3.12
  memorySize: 512
  timeout: 7
  iam:
    role: arn:aws:iam::819959187501:role/LabRole

functions:
  setUp:
    handler: setUp.lambda_handler
    environment:
      SECURITY_STAFF_TABLE: "SecurityStaff"
      VIDEO_SIMULATION_STORAGE: "SimulationVideos"
      VIDEO_CLOUD_STORAGE: "SmartSurveillance"
      OFFENDERS_TABLE: "Offenders"
      OFFENDERS_COLLECTION:
        Ref: OffendersCollection
      PEOPLE_COLLECTION:
        Ref: PeopleCollection

  simulateVideoStream: # create liveVideo topic post
    handler: simulateVideoStream.lambda_handler
    environment:
      VIDEO_SIMULATION_STORAGE: "SmartSurveillance"
      VIDEO_CLOUD_STORAGE: "SmartSurveillance"
      SECURITY_STAFF_TABLE: "SecurityStaff"
      RECORDED_PEOPLE_TABLE: "RecordedPeople"
      LOCAL_VIDEOS_PATH: "/home/ubuntu/videos"
      LOCAL_IMAGES_PATH: "/home/ubuntu/images"
      SNS_TOPIC_ARN:
        Ref: LiveVideoStream

  saveVideo:
    handler: saveVideo.lambda_handler
    environment:
      SECURITY_STAFF_TABLE: "SecurityStaff"
      PEOPLE_TABLE: "People"
      CLOUD_STORAGE: "SmartSurveillance"

  processFrame:
    handler: processFrame.lambda_handler
    environment:
      SECURITY_STAFF_TABLE: "SecurityStaff"
      CLOUD_STORAGE: "SmartSurveillance"
      OFFENDERS_COLLECTION:
        Ref: OffendersCollection
    events:
      - sqs:
          arn:
            Ref: LiveVideoStreamQueue
          batchSize: 5
          maximumBatchingWindow: 15

  alertOffenderFound:
    handler: alertOffenderFound.lambda_handler
    environment:
      SNS_TOPIC_ARN:
        Ref: OffenderAlert
    events:
      - sqs:
          arn:
            Ref: OffenderAlertQueue
          batchSize: 5
          maximumBatchingWindow: 10

  suspectSearch:
    handler: suspectSearch.lambda_handler
    environment:
      ACCESS_TOKENS_TABLE: "AccessTokens"
      RECORDED_PEOPLE_TABLE: "RecordedPeople"
    events:
      - http:
          path: /person/search
          method: post
          cors: true
          integration: lambda

resources:
  Resources:
    # DynamoDB
    AccessTokens:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: AccessTokens
        AttributeDefinitions:
          - AttributeName: token
            AttributeType: S
        KeySchema:
          - AttributeName: token
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    People:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: People
        AttributeDefinitions:
          - AttributeName: person_id
            AttributeType: S
        KeySchema:
          - AttributeName: person_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    Offenders:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Offenders
        AttributeDefinitions:
          - AttributeName: person_id
            AttributeType: S
        KeySchema:
          - AttributeName: person_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    SecurityStaff:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: SecurityStaff
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    Cameras:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Cameras
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: camera_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: camera_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    RecordedPeople:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: RecordedPeople
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: person_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: person_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
  # S3
  resources:
    SimulationVideos:
      Type: AWS::S3::Bucket

    SmartSurveillance:
      Type: AWS::S3::Bucket

    SmartSurveillanceImages:
      Type: AWS::S3::Bucket
    # SNS
    LiveVideoStream:
      Type: AWS::SNS::Topic
      Properties:
        Subscription:
          - Endpoint:
              Ref: "LiveVideoStreamQueue"
            Protocol: "sqs"
        TopicName: "LiveVideoStream"

    OffenderAlert:
      Type: AWS::SNS::Topic
      Properties:
        Subscription:
          - Endpoint:
              Ref: "OffenderAlertQueue"
            Protocol: "sqs"
        TopicName: "OffenderAlert"
    # SQS
    LiveVideoStreamQueue:
      Type: AWS::SQS::Queue
      Properties:
        RedrivePolicy:
          deadLetterTargetArn:
            Ref: LiveVideoStreamDLQ
        maxReceiveCount: 5
        QueueName: "LiveVideoStreamQueue"

    LiveVideoStreamDLQ:
      Type: AWS::SQS::Queue

    OffenderAlertQueue:
      Type: AWS::SQS::Queue
      Properties:
        RedrivePolicy:
          deadLetterTargetArn:
            Ref: OffenderAlertDLQ
        maxReceiveCount: 5
        QueueName: "OffenderAlertQueue"

    OffenderAlertDLQ:
      Type: AWS::SQS::Queue
    # Rekognition Collection
    PeopleCollection:
      Type: AWS::Rekognition::Collection
      Properties:
        CollectionId: PeopleCollection
    OffendersCollection:
      Type: AWS::Rekognition::Collection
      Properties:
        CollectionId: OffendersCollection
    # EventBridge
    PermissionForEventBridgeToInvokeLambda:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !Ref simulateVideoStream
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
